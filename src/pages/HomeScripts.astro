<script>
    /**
     * Home Page Scripts
     * 简约的页面初始化和交互处理 - 解决 View Transition 冲突
     */

    // ==================== 页面初始化 ====================
    
    const initializePage = (): void => {
        // 确保页面加载时滚动到顶部
        window.scrollTo({
            top: 0,
            behavior: 'instant' as ScrollBehavior
        });

        // 添加页面加载完成的类
        document.body.classList.add('page-loaded');
    };

    // ==================== 卡片交互增强 ====================
    
    const enhanceCardInteractions = (): void => {
        const cards = document.querySelectorAll('.home-card') as NodeListOf<HTMLElement>;
        
        cards.forEach(card => {
            const link = card.querySelector('a');
            
            if (link) {
                // 添加平滑的点击反馈
                link.addEventListener('click', (e) => {
                    card.style.transition = 'transform 0.2s ease';
                    card.style.transform = 'scale(0.95)';
                    
                    setTimeout(() => {
                        card.style.transform = '';
                    }, 200);
                });
            }
        });
    };

    // ==================== 视图过渡支持 - 关键修改 ====================
    
    const handleViewTransitions = (): void => {
        // 在页面切换前保存状态
        document.addEventListener('astro:before-preparation', () => {
            sessionStorage.setItem('from-home', 'true');
        });

        // 监听 View Transition 完成
        document.addEventListener('astro:after-swap', () => {
            // View Transition 完成后，等待一小段时间再初始化
            // 这样可以避免动画冲突
            requestAnimationFrame(() => {
                initializePage();
                enhanceCardInteractions();
            });
        });
        
        // 新增: 确保 View Transition 完全结束后再播放卡片动画
        document.addEventListener('astro:page-load', () => {
            const cards = document.querySelectorAll('.home-card') as NodeListOf<HTMLElement>;
            
            // 恢复被禁用的 view-transition-name
            // 这样从 Home -> Blog Detail 时，图片又能拥有平滑的过渡动画了
            cards.forEach(card => {
                const img = card.querySelector('img');
                // 检查是否有被强制设为 none 的样式
                if (img && img.style.getPropertyValue('view-transition-name') === 'none') {
                    img.style.removeProperty('view-transition-name');
                }
            });

            // 2. 重新触发动画 (如果需要)
            cards.forEach(card => {
                const computedStyle = window.getComputedStyle(card);
                if (computedStyle.animationPlayState === 'paused') {
                    // 强制重新开始动画
                    card.style.animation = 'none';
                    requestAnimationFrame(() => {
                        card.style.animation = '';
                    });
                }
            });
        });
    };

    // ==================== 随机化卡片 ====================
    
    const randomizeCards = (): void => {
        const container = document.getElementById('cards-container');
        if (!container) return;

        const allCards = Array.from(container.querySelectorAll('.home-card')) as HTMLElement[];
        if (allCards.length === 0) return;

        // 1. 随机打乱所有候选卡片
        const shuffled = allCards.sort(() => Math.random() - 0.5);
        
        // 2. 随机决定展示数量 (6-7个)
        const count = 6 + Math.floor(Math.random() * 2);
        const selected = shuffled.slice(0, count);

        // 3. 清空现有显示，重新排列 DOM（为了让 CSS 的 nth-child 动画顺序生效）
        container.innerHTML = '';
        
        selected.forEach((card) => {
            // 4. 生成随机位置和旋转
            const rotation = (Math.random() - 0.5) * 16;
            const offsetX = (Math.random() - 0.5) * 1200;
            const offsetY = (Math.random() - 0.5) * 120 - 80;

            // 5. 应用 CSS 变量
            card.style.setProperty('--rotation', `${rotation}deg`);
            card.style.setProperty('--offset-x', `${offsetX}px`);
            card.style.setProperty('--offset-y', `${offsetY}px`);
            
            // 6. 显示卡片
            card.style.display = 'block';
            card.style.visibility = 'visible';
            
            container.appendChild(card);
        });
    };

    // ==================== 初始化流程 ====================
    
    const initialize = (): void => {
        initializePage();
        enhanceCardInteractions();
        handleViewTransitions();
    };

    // ==================== 事件监听 ====================
    
    // Astro 视图过渡事件

    document.addEventListener('astro:page-load', () => {
        randomizeCards();
        initialize();
    });
    
    // 浏览器前进/后退
    window.addEventListener('pageshow', initialize);

    // DOM 加载完成
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }

    // 导出工具函数（可选）
    if (typeof window !== 'undefined') {
        (window as any).homePageUtils = {
            initializePage,
            enhanceCardInteractions
        };
    }
</script>