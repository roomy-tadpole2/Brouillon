---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import HomeStyles from './HomeStyle.astro';
import HomeScripts from './HomeScripts.astro';

// 获取所有有封面图的博客文章作为候选池
const allPosts = (await getCollection('blog')).filter(post => post.data.heroImage);
---

<BaseLayout title={SITE_TITLE} description={SITE_DESCRIPTION}>
    <main>
        <section class="home-header">
            <h1 class="home-title">Le brouillon d'Adam</h1>
        </section>

        <section class="cards-section">
            <div class="cards-container" id="cards-container">
                {
                    allPosts.map((post) => (
                        <div 
                            class="home-card" 
                            style="display: none; visibility: hidden;" 
                            data-post-id={post.id}
                        >
                            <a href={`/blog/${post.id}/`}>
                                {post.data.heroImage && (
                                    <Image 
                                        width={1200} 
                                        height={1200} 
                                        quality={100}
                                        format="png"
                                        src={post.data.heroImage} 
                                        alt={post.data.title}
                                        transition:name={`hero-${post.id}`} 
                                    />
                                )}
                            </a>
                        </div>
                    ))
                }
            </div>
        </section>
    </main>

    <HomeStyles />
    <HomeScripts />
    
    <!-- 移动设备自动跳转脚本 -->
    <script>
        /**
         * 检测移动设备/平板并自动跳转到 /blog
         */
        (function() {
            // 检测屏幕宽度（1024px 及以下视为移动设备/平板）
            const isMobileOrTablet = window.innerWidth <= 1024;
            
            if (isMobileOrTablet) {
                // 检查是否正在跳转（防止无限循环）
                const isRedirecting = sessionStorage.getItem('home-redirecting');
                
                if (!isRedirecting) {
                    // 标记正在跳转
                    sessionStorage.setItem('home-redirecting', 'true');
                    
                    // 跳转到 /blog
                    window.location.href = '/blog';
                }
            } else {
                // 桌面设备：清除跳转标记（允许用户返回查看）
                const fromBlog = document.referrer.includes('/blog');
                if (fromBlog) {
                    sessionStorage.removeItem('home-redirecting');
                }
            }
        })();
    </script>
</BaseLayout>