<script>
    /**
     * Blog Index Page Scripts with Smooth Grid Animation
     * ä½¿ç”¨ FLIP æŠ€æœ¯å®ç°å¹³æ»‘çš„ç½‘æ ¼é‡æ’åŠ¨ç”»
     */

    // ==================== æ»šåŠ¨ä½ç½®ç®¡ç† ====================
    
    const saveScrollPosition = (): void => {
        const currentPath = window.location.pathname;
        if (currentPath === '/blog' || currentPath === '/blog/') {
            sessionStorage.setItem('blog-scroll-pos', window.scrollY.toString());
        }
    };

    const handleScrollBehavior = (): void => {
        const path = window.location.pathname;
        const savedScrollPos = sessionStorage.getItem('blog-scroll-pos');

        if (path.includes('/blog/') && path !== '/blog' && path !== '/blog/') {
            window.scrollTo({
                top: 0,
                behavior: 'instant' as ScrollBehavior
            });
        } 
        else if ((path === '/blog' || path === '/blog/') && savedScrollPos) {
            requestAnimationFrame(() => {
                window.scrollTo({
                    top: parseInt(savedScrollPos, 10),
                    behavior: 'instant' as ScrollBehavior
                });
            });
        }
    };

    // ==================== å¹³æ»‘æœç´¢åŠ¨ç”» ====================

    const initSearch = (): void => {
        const searchInput = document.getElementById('search-input') as HTMLInputElement;
        const postCards = document.querySelectorAll('.post-card') as NodeListOf<HTMLElement>;
        const postsList = document.getElementById('posts-list') as HTMLElement;

        if (!searchInput || !postsList) {
            console.warn('Search elements not found');
            return;
        }

        // é˜²æŠ–å‡½æ•°
        let debounceTimer: number;
        const debounce = (callback: Function, delay: number = 150) => {
            return (...args: any[]) => {
                clearTimeout(debounceTimer);
                debounceTimer = window.setTimeout(() => callback(...args), delay);
            };
        };

        /**
         * FLIP åŠ¨ç”»æŠ€æœ¯
         * First: è®°å½•åˆå§‹ä½ç½®
         * Last: æ”¹å˜ DOMï¼ˆæ·»åŠ /ç§»é™¤ hidden ç±»ï¼‰
         * Invert: è®¡ç®—ä½ç½®å·®
         * Play: æ’­æ”¾åŠ¨ç”»
         */
        const animateGridReflow = (cardsToShow: Set<HTMLElement>, cardsToHide: Set<HTMLElement>): void => {
            // === FIRST: è®°å½•æ‰€æœ‰å¡ç‰‡çš„åˆå§‹ä½ç½® ===
            const firstPositions = new Map<HTMLElement, DOMRect>();
            postCards.forEach(card => {
                firstPositions.set(card, card.getBoundingClientRect());
            });

            // === LAST: æ”¹å˜ DOM çŠ¶æ€ ===
            // å…ˆæ·¡å‡ºè¦éšè—çš„å¡ç‰‡
            cardsToHide.forEach(card => {
                card.style.opacity = '0';
                card.style.transform = 'scale(0.9)';
            });

            // ç­‰å¾…æ·¡å‡ºåŠ¨ç”»å®Œæˆåå†éšè—
            setTimeout(() => {
                cardsToHide.forEach(card => {
                    card.classList.add('hidden');
                    card.setAttribute('aria-hidden', 'true');
                });

                cardsToShow.forEach(card => {
                    card.classList.remove('hidden');
                    card.setAttribute('aria-hidden', 'false');
                });

                // === INVERT & PLAY: è®¡ç®—å¹¶æ’­æ”¾ç§»åŠ¨åŠ¨ç”» ===
                requestAnimationFrame(() => {
                    const visibleCards = Array.from(postCards).filter(card => !card.classList.contains('hidden'));
                    
                    visibleCards.forEach((card, index) => {
                        const firstPos = firstPositions.get(card);
                        const lastPos = card.getBoundingClientRect();

                        if (firstPos) {
                            const deltaX = firstPos.left - lastPos.left;
                            const deltaY = firstPos.top - lastPos.top;

                            // åº”ç”¨åå‘å˜æ¢ï¼ˆInvertï¼‰
                            card.style.transition = 'none';
                            card.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(0.9)`;
                            card.style.opacity = '0';

                            // å¼ºåˆ¶é‡æ’
                            card.offsetHeight;

                            // æ’­æ”¾åŠ¨ç”»ï¼ˆPlayï¼‰
                            card.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                            card.style.transitionDelay = `${index * 0.03}s`;
                            card.style.transform = 'translate(0, 0) scale(1)';
                            card.style.opacity = '1';
                        }
                    });

                    // æ¸…ç†è¿‡æ¸¡æ ·å¼
                    setTimeout(() => {
                        visibleCards.forEach(card => {
                            card.style.transition = '';
                            card.style.transitionDelay = '';
                            card.style.transform = '';
                        });
                    }, 400 + visibleCards.length * 30);
                });
            }, 200);
        };

        // æœç´¢å¤„ç†å‡½æ•°
        const handleSearch = (searchTerm: string): void => {
            const term = searchTerm.toLowerCase().trim();
            const cardsToShow = new Set<HTMLElement>();
            const cardsToHide = new Set<HTMLElement>();
            let visibleCount = 0;

            postCards.forEach(card => {
                const title = card.getAttribute('data-title') || '';
                const isCurrentlyHidden = card.classList.contains('hidden');
                
                if (term === '' || title.includes(term)) {
                    if (isCurrentlyHidden) {
                        cardsToShow.add(card);
                    }
                    visibleCount++;
                } else {
                    if (!isCurrentlyHidden) {
                        cardsToHide.add(card);
                    }
                }
            });

            // æ‰§è¡Œå¹³æ»‘åŠ¨ç”»
            if (cardsToShow.size > 0 || cardsToHide.size > 0) {
                animateGridReflow(cardsToShow, cardsToHide);
            }

            // æ˜¾ç¤ºæœç´¢ç»“æœæç¤º
            console.log(`æ˜¾ç¤º ${visibleCount} ä¸ªç»“æœï¼Œå…± ${postCards.length} ç¯‡æ–‡ç« `);
            showNoResultsMessage(visibleCount === 0);
        };

        // æ˜¾ç¤º/éšè—"æœªæ‰¾åˆ°ç»“æœ"æç¤º
        const showNoResultsMessage = (show: boolean): void => {
            let messageEl = document.getElementById('no-results-message');
            
            if (show) {
                if (!messageEl) {
                    messageEl = document.createElement('div');
                    messageEl.id = 'no-results-message';
                    messageEl.textContent = 'No results found ğŸ˜¢';
                    messageEl.style.cssText = `
                        text-align: center;
                        padding: 3rem 1rem;
                        color: #6b7280;
                        font-size: 1.1rem;
                        grid-column: 1 / -1;
                        opacity: 0;
                        animation: fadeIn 0.4s ease forwards;
                        animation-delay: 0.2s;
                    `;
                    postsList.appendChild(messageEl);
                }
            } else {
                if (messageEl) {
                    messageEl.style.opacity = '0';
                    setTimeout(() => messageEl?.remove(), 300);
                }
            }
        };

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        searchInput.addEventListener('input', debounce((e: Event) => {
            const target = e.target as HTMLInputElement;
            handleSearch(target.value);
        }));

        // ESC é”®æ¸…ç©ºæœç´¢
        searchInput.addEventListener('keydown', (e: KeyboardEvent) => {
            if (e.key === 'Escape') {
                searchInput.value = '';
                handleSearch('');
                searchInput.blur();
            }
        });

        // åˆå§‹åŒ–
        searchInput.value = '';
    };

    // ==================== åˆå§‹åŒ– ====================

    const initializePage = (): void => {
        handleScrollBehavior();
        initSearch();
    };

    // äº‹ä»¶ç›‘å¬
    document.addEventListener('astro:before-preparation', saveScrollPosition);
    document.addEventListener('astro:after-swap', initializePage);
    window.addEventListener('pageshow', initializePage);

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePage);
    } else {
        initializePage();
    }

    // å¯¼å‡ºå·¥å…·å‡½æ•°
    if (typeof window !== 'undefined') {
        (window as any).blogIndexUtils = {
            saveScrollPosition,
            handleScrollBehavior,
            initSearch
        };
    }
</script>