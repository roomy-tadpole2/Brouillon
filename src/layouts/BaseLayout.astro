---
// src/layouts/BaseLayout.astro
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { ClientRouter } from 'astro:transitions'; 
import stain_colors from './stain_palette.json'; 

const { title, description, transitionSpeed = "0.8s" } = Astro.props;
---

<html lang="zh">
  <head>
    <BaseHead title={title} description={description} />
    <ClientRouter />
    
    <style is:global define:vars={{ transitionSpeed }}>
      ::view-transition-old(root),
      ::view-transition-new(root) {
        animation-duration: var(--transitionSpeed) !important;
      }

      /* 背景装饰基础样式 */
      .bg-decor {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: -1;
        overflow: hidden;
        pointer-events: none;
        opacity: 0.9;
      }

      .decor-circle {
        position: absolute;
        border-radius: 50%;
        filter: blur(65px); /* 增加模糊度让光晕更柔和 */
        opacity: 0; /* 初始为透明 */
        transition: all 1.8s ease-in-out;
      }

      /* 光晕淡入动画 */
      .decor-circle.fade-in {
        opacity: 0.42;
      }

      /* ==================== 页面元素淡入动画 ==================== */
      
      /* Header 淡入 */
      body > header {
        opacity: 0;
        transform: translateY(-20px);
        animation: fadeInDown 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        animation-delay: 0.6s;
      }

      /* 主内容区域淡入 */
      body > main {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        animation-delay: 0.6s;
      }

      /* Footer 淡入 */
      body > footer {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        animation-delay: 0.6s;
      }

      /* 淡入动画关键帧 - 从上方 */
      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* 淡入动画关键帧 - 从下方 */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* 页面已加载状态 - 移除动画以避免重复 */
      body.page-loaded > header,
      body.page-loaded > main,
      body.page-loaded > footer {
        animation: none;
        opacity: 1;
        transform: none;
      }
    </style>
  </head>

  <body>
    <div class="bg-decor" id="bg-decor"></div>

    <Header />
    <slot />
    <Footer />

    <script define:vars={{ stain_colors }}>
      const generateDecor = () => {
        const container = document.getElementById('bg-decor');
        if (!container) return;
        
        // 清空现有光晕（用于页面切换时重新生成）
        container.innerHTML = '';

        const createCircle = (side, index, total) => {
          const circle = document.createElement('div');
          circle.classList.add('decor-circle');

          // 1. 随机大小 (150px 到 450px 之间)
          const size = Math.floor(Math.random() * 120) + 240;
          
          // 2. 随机颜色
          const color = stain_colors.colors[Math.floor(Math.random() * stain_colors.colors.length)];
          
          // 3. 随机位置
          // y 轴在 0-100% 之间
          const top = Math.floor(Math.random() * 100) + 0;
          // x 轴限制在两侧
          let left;
          if (side === 'left') {
            left = Math.floor(Math.random() * 18) - 12; // 允许稍微超出左边界
          } else {
            left = Math.floor(Math.random() * 10) + 80; // 允许稍微超出右边界
          }

          // 应用样式
          Object.assign(circle.style, {
            width: `${size}px`,
            height: `${size}px`,
            backgroundColor: color.startsWith('var') ? color : color, // 支持 CSS 变量或 Hex
            top: `${top}%`,
            left: `${left}%`,
            transitionDelay: `${index * 0.08}s` // 交错延迟
          });

          container.appendChild(circle);

          // 使用 requestAnimationFrame 确保过渡效果生效
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              circle.classList.add('fade-in');
            });
          });
        };

        // 每侧随机生成光晕
        const countLeft = Math.floor(Math.random() * 3) + 3;
        const countRight = Math.floor(Math.random() * 3) + 3;

        for (let i = 0; i < countLeft; i++) createCircle('left', i, countLeft);
        for (let i = 0; i < countRight; i++) createCircle('right', i + countLeft, countLeft + countRight);
      };

      // 标记页面已加载，避免后续导航时重复动画
      const markPageLoaded = () => {
        // 延迟标记，确保动画完成
        setTimeout(() => {
          document.body.classList.add('page-loaded');
        }, 1000);
      };

      // 初始化
      const initialize = () => {
        // 移除已加载标记以重新触发动画
        document.body.classList.remove('page-loaded');
        generateDecor();
        markPageLoaded();
      };

      // 页面首次加载
      initialize();

      // Astro 视图过渡
      document.addEventListener('astro:page-load', initialize);

      // 浏览器前进/后退
      window.addEventListener('pageshow', (event) => {
        // 如果是从缓存恢复，重新初始化
        if (event.persisted) {
          initialize();
        }
      });
    </script>
  </body>
</html>